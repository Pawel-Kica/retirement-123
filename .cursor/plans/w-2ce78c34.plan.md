<!-- 2ce78c34-d63a-4903-b101-080967347ec2 e3e6ae81-c6bf-4d31-a471-1e0e93e21af1 -->
# Wynik jako domyślny + super‑kustomizacja (C, C, A)

## Zakres wymagań – pełne pokrycie

- **Domyślny start na wyniku**: autowartości, szybkie edycje; formularz skrócony do jednego kroku.
- **Slidery + natychmiastowe wykresy**: wiek przejścia, wzrost płac, udział składek; wszystkie KPI i wykresy aktualizują się w czasie rzeczywistym.
- **Akcje na osi czasu**: dodawanie/edycja/usuwanie zdarzeń: urlop macierzyński, bezpłatny, długie L4, zmiana pensji.
- **Segmenty wynagrodzeń**: np. „2015–2024: 20 000 zł, wcześniej 5 000 zł” + typ umowy per segment.
- **Typy umów**: `UOP`, `B2B`, `UZ`, `UoD` – konfigurowalne stawki wpływające na składkę emerytalną.
- **PPK (+5%) i IKZP (+10%)**: proste podbicie rocznych składek (konfigurowalne), widoczny wpływ na wykresach.

## Strategia bezinwazyjna (zachowanie istniejącej logiki)

- **Nie usuwamy istniejących modułów**: `buildSalaryPath`, `accumulateCapital`, `l4Impact`, `pensionCalculation`, `deferralScenarios` – zostają bez zmian.
- **Warstwa rozszerzeń zamiast przebudowy**:
- Nowy plik: `lib/engine/extensions.ts` – funkcje modyfikujące ścieżkę wynagrodzeń PRZED wywołaniem `accumulateCapital`.
- Główna funkcja `calculateSimulation` w `lib/engine/index.ts` dostaje opcjonalny krok „extensions”, ale domyślnie zwraca te same wyniki, jeśli rozszerzenia są wyłączone.
- **Feature flags i wartości domyślne**: wszystkie nowe opcje OFF by default; przy wartościach domyślnych wyniki ≡ obecnym.
- **Test niezmienności**: snapshot dla bazowego scenariusza przed/po – musi się zgadzać co do grosza.

## Zmiany w typach i kontekście (rozszerzenia)

- `lib/types.ts` – dodajemy bez naruszania istniejących:
- `ContractType = 'UOP'|'B2B'|'UZ'|'UoD'`
- `SalarySegment { fromYear; toYear; grossMonthly; contract: ContractType }`
- `TimelineEventType = 'maternity'|'unpaid_leave'|'sick_long'|'salary_change'`
- `TimelineEvent { fromYear; toYear; type: TimelineEventType; factor?: number }`
- `ContributionBoost { ppk:boolean; ikzp:boolean }`
- `DashboardModifications` rozszerzamy o: `salarySegments?: SalarySegment[]`, `timelineEvents?: TimelineEvent[]`, `contractOverrides?: Record<number, ContractType>`, `contributionBoost?: ContributionBoost`.
- `lib/context/SimulationContext.tsx` – tylko dodanie pól i akcji (persistencja jak dotąd), żadnych usunięć.

## Silnik – warstwa rozszerzeń

- `lib/engine/extensions.ts` (czyste funkcje):
- `segmentsToOverrides(segments) -> Record<year, salary>` – mapuje segmenty na roczne nadpisania dla istniejącego `buildSalaryPath`.
- `applyContractRates(path, contractMap) -> path` – modyfikuje efektywną podstawę składek dla roku.
- `applyPPKandIKZP(path, boosts) -> path` – zwiększa roczne składki o +5%/+10% (parametryzowane).
- `applyTimelineEvents(path, events, l4Data?) -> path` – redukcje/zerowania składek w okresach (macierzyński, bezpłatny, długie L4).
- Przepływ w `calculateSimulation`:
1) `buildSalaryPath(...)` (istniejące)
2) jeśli są modyfikacje: kolejno `segmentsToOverrides` → `applyContractRates` → `applyPPKandIKZP` → `applyTimelineEvents`
3) `accumulateCapital(...)` (istniejące)
4) reszta jak dziś: `calculatePension`, `calculateRealValue`, `deferralScenarios`.

## Konfiguracja stawek umów

- `lib/config/contributionRates.ts` – proste, edytowalne współczynniki np. `UOP: 1.0`, `B2B: 0.4`, `UZ: 0.6`, `UoD: 0.0` (przykłady; finalnie ustalimy wartości z DS/założeń).

## UI/UX (ZUS DS)

- `app/wynik/page.tsx` – dodajemy:
- `QuickControls` (slidery i przełączniki PPK/IKZP) – z `InputWithSlider`, kolory/typografia wg DS.
- `SalarySegmentsEditor` – tabela + dodawanie zakresów lat, pensji, umowy.
- `EventsEditor` – lista zdarzeń + formularz dodawania (typ, od‑do, współczynnik).
- `TimelineBar` – wizualizacja segmentów i zdarzeń (rozszerzenie `UnifiedTimeline`).
- Wykresy Chart.js z aktualizacją po zmianach (debounce 200 ms).
- `app/symulacja/page.tsx` – skrócenie do jednego kroku i przycisk „Przejdź do wyniku (domyślnie)”; logika walidacji zostaje.

## Wydajność i UX

- Debounce 200 ms przy zmianach; memoizacja przeliczania ścieżki.
- Responsywność i czytelne focus states (AA). Wszystkie napisy po polsku.

## Kryteria akceptacji (doprecyzowane)

- Wyniki bazowe bez włączonych rozszerzeń są identyczne z obecnymi (snapshot test).
- Edytor segmentów i zdarzeń działa w pełnym zakresie; wpływ widoczny na wykresach i KPI.
- PPK/IKZP zmieniają kapitał wg +5%/+10% (konfigurowalne).
- Typ umowy na segment wpływa na składkę.
- Start na `/wynik` z autowartościami; formularz skrócony.
- Wszystko zgodne z ZUS DS.

### To-dos

- [ ] Dodać `lib/engine/formulas.ts` z czystymi funkcjami i integracją w index.ts
- [ ] Rozszerzyć `lib/types.ts` o segmenty, zdarzenia, kontrakty, boosty
- [ ] Dodać `lib/config/contributionRates.ts` z prostymi stawkami
- [ ] Rozszerzyć `SimulationContext` o nowe pola i akcje
- [ ] Dodać panel `QuickControls` na `app/wynik/page.tsx`
- [ ] Stworzyć `SalarySegmentsEditor` do segmentów pensji
- [ ] Stworzyć `ContractSegmentsEditor` z wyborem umów
- [ ] Stworzyć `EventsEditor` do macierzyńskiego/bezpłatnego/L4/zmian pensji
- [ ] Rozszerzyć `UnifiedTimeline` o akcje i kolory stanu
- [ ] Uaktualnić wykresy w wyniku na reaktywne (Chart.js)
- [ ] Skrócić `app/symulacja/page.tsx` do jednego kroku z autofill
- [ ] Zaktualizować zapis scenariuszy i eksport PDF/XLSX
- [ ] Dodać walidacje zakresów i ARIA/focus dla nowych kontrolek
- [ ] Uzupełnić polskie etykiety/tooltipy zgodnie z DS